"use strict";(self.webpackChunkcelestianote=self.webpackChunkcelestianote||[]).push([[792],{866:(e,t,n)=>{var o=n(922),i=n(437),a=n(24),r=n(411),s=n(880),l=n(977),d=n(92);console.log("THREE.REVISION:",o.sPf);const c=document.getElementById("sceneCanvas"),p=new i.JeP({canvas:c,antialias:!0,preserveDrawingBuffer:!0,alpha:!0});p.setClearColor(0,0),p.autoClear=!1,p.setSize(window.innerWidth,window.innerHeight),p.outputColorSpace=o.er$,document.body.appendChild(p.domElement);const u=new r.a0;u.domElement.classList.add("css3d-renderer"),u.setSize(window.innerWidth,window.innerHeight),u.domElement.style.position="absolute",u.domElement.style.top=0,document.body.appendChild(u.domElement);const y=new o.Z58,h=new o.ubm(75,window.innerWidth/window.innerHeight,.1,200);h.position.set(0,1.6,5);const m=new o.Z58,g=new o.qUd(-window.innerWidth/2,window.innerWidth/2,window.innerHeight/2,-window.innerHeight/2,.1,100);g.position.z=10;const w=new o.$p8(16777215,1.5);y.add(w);const f=new o.Tap,P=f.load("./Model/markup_ARROW.png"),v=f.load("./Model/markup_WASD.png"),b=f.load("./Model/Mouse.png"),x=f.load("./Model/Mouse_Arrow.png"),M=new o.RoJ({map:P,transparent:!0,opacity:1}),I=new o.kxk(M);I.scale.set(160,120,1),I.position.set(-window.innerWidth/2+20,-window.innerHeight/2+20,1),m.add(I);const q=new o.RoJ({map:b,transparent:!0,opacity:1}),S=new o.kxk(q);S.scale.set(70,70,1),S.position.set(-window.innerWidth/2+130,-window.innerHeight/2+40,1),m.add(S);const A=new o.RoJ({map:x,transparent:!0,opacity:1}),O=new o.kxk(A);O.scale.set(50,50,1),O.position.set(-window.innerWidth/2+130,-window.innerHeight/2+40,1),m.add(O);let E=!1;function C(){I.position.set(g.left+90,g.bottom+70,1)}setInterval((()=>{M.map=E?v:P,M.needsUpdate=!0,E=!E}),1e3);let z=null,T=null;function k(e=!1){if(z)return;let t,n;T=e?"center":"left",e?(t=(g.left+g.right)/2,n=g.bottom+45):(t=g.left+230,n=g.bottom+45),S.position.set(t,n,1),O.position.set(t+50,n+20,1),S.material.rotation=0,O.material.rotation=-Math.PI/16,z=s.Ay.timeline({repeat:-1,yoyo:!0,ease:"circ.inOut",defaults:{duration:2}}),z.to(S.position,{x:t+70,y:n+40},0),z.to(S.material,{rotation:-Math.PI/16},0),z.to(O.position,{x:t,y:n+5},0),z.to(O.material,{rotation:3*Math.PI/5},0)}function L(){z&&(z.kill(),z=null,S.material.rotation=0,O.material.rotaation=-Math.PI/16,C())}function B({texturePath:e,size:t=[30,30],position:n=[0,0,0],renderOrder:i=200}){(new o.Tap).load(e,(e=>{const[a,r]=t,s=new o.bdM(a,r),l=new o.V9B({map:e,transparent:!0,depthTest:!0,depthWrite:!1,alphaTest:.4}),d=new o.eaF(s,l);d.raycast=()=>{},d.position.set(...n),d.renderOrder=i,d.lookAt(h.position),y.add(d)}))}k(),B({texturePath:"./texture/miku.png",size:[20,40],position:[0,15,50],renderOrder:222}),B({texturePath:"./texture/eight.png",size:[20,20],position:[-55,5,-70],renderOrder:223}),B({texturePath:"./texture/DEight.png",size:[10,10],position:[40,20,-30],renderOrder:224}),B({texturePath:"./texture/magi.png",size:[90,45],position:[0,8,-60],renderOrder:225}),B({texturePath:"./texture/four.png",size:[20,20],position:[40,8,-10],renderOrder:226}),B({texturePath:"./texture/sixt.png",size:[20,20],position:[-55,30,-20],renderOrder:227}),B({texturePath:"./texture/ruka.png",size:[20,40],position:[25,15,20],renderOrder:228}),B({texturePath:"./texture/kagamine.png",size:[15,30],position:[-20,10,10],renderOrder:229}),B({texturePath:"./texture/four.png",size:[20,20],position:[30,80,-40],renderOrder:230});const W=[{position:new o.Pq0(2.8,0,6),rotation:new o.O9p(0,Math.PI/5,-Math.PI/5),scale:new o.Pq0(.125,.125,.125)},{position:new o.Pq0(-2.9,0,4),rotation:new o.O9p(-Math.PI/4,Math.PI/9,0),scale:new o.Pq0(.1,.1,.1)},{position:new o.Pq0(1.5,0,7),rotation:new o.O9p(0,Math.PI/3,-Math.PI/6),scale:new o.Pq0(.125,.125,.125)},{position:new o.Pq0(-2.5,0,6.5),rotation:new o.O9p(0,-Math.PI/2,Math.PI/5),scale:new o.Pq0(.11,.11,.11)},{position:new o.Pq0(.5,0,6),rotation:new o.O9p(-Math.PI/7,-Math.PI/4,-Math.PI/3),scale:new o.Pq0(.04,.04,.04)},{position:new o.Pq0(.23,0,4),rotation:new o.O9p(-Math.PI/3,-Math.PI/4,-Math.PI/3),scale:new o.Pq0(.05,.05,.05)},{position:new o.Pq0(2.2,0,1.7),rotation:new o.O9p(-Math.PI/7,-Math.PI/4,-Math.PI/3),scale:new o.Pq0(.08,.08,.08)},{position:new o.Pq0(-2.2,0,2.6),rotation:new o.O9p(-2*Math.PI/5,-Math.PI/4,-Math.PI/3),scale:new o.Pq0(.06,.06,.06)},{position:new o.Pq0(-2.5,0,7.1),rotation:new o.O9p(-Math.PI/8,-Math.PI/3,Math.PI/3),scale:new o.Pq0(.05,.05,.05)},{position:new o.Pq0(-1.2,0,6.1),rotation:new o.O9p(-Math.PI/7,-Math.PI/4,-Math.PI/3),scale:new o.Pq0(.05,.05,.05)},{position:new o.Pq0(2.2,0,7.5),rotation:new o.O9p(-Math.PI/6,-Math.PI/7,-Math.PI/5),scale:new o.Pq0(.05,.05,.05)},{position:new o.Pq0(1,0,8.5),rotation:new o.O9p(-Math.PI/7,-Math.PI/4,Math.PI/8),scale:new o.Pq0(.08,.08,.08)},{position:new o.Pq0(-.9,0,6.3),rotation:new o.O9p(-Math.PI/7,-Math.PI/2,Math.PI/3),scale:new o.Pq0(.07,.07,.07)},{position:new o.Pq0(-1,0,8),rotation:new o.O9p(0,-Math.PI/3,3*Math.PI/8),scale:new o.Pq0(.17,.17,.17)},{position:new o.Pq0(-.4,0,7.6),rotation:new o.O9p(0,-Math.PI/3,Math.PI/4),scale:new o.Pq0(.09,.09,.09)},{position:new o.Pq0(-.5,0,1.5),rotation:new o.O9p(Math.PI/4,Math.PI/7,0),scale:new o.Pq0(.1,.1,.1)}],R=[];let H,_,D,$,F;(new d.B).load("./Model/StarRightModel/StarRight.glb",(function(e){const t=e.scene;W.forEach((e=>{const n=t.clone(!0);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),n.traverse((e=>{e.isMesh&&e.material&&(e.material=e.material.clone(),e.material.color=new o.Q1f(14540253))})),y.add(n),R.push(n)}))})),(new d.B).load("./Model/FloorModel/floor.glb",(function(e){H=e.scene,H.traverse((e=>{e.isMesh&&(e.renderOrder=500,e.material.depthWrite=!1,e.material.transparent=!0)})),H.scale.set(.25,.25,.25),H.position.set(0,0,5),y.add(H),console.log(" GLBモデル読み込み完了")}),void 0,(function(e){console.error(" GLB読み込みエラー:",e)})),(new d.B).load("./Model/AmpModel/amp.glb",(function(e){_=e.scene,_.scale.set(.24,.24,.24),_.position.set(-2,0,7.3),_.rotation.y=4*Math.PI/5,y.add(_),V(_),console.log(" GLBモデル読み込み完了")}),void 0,(function(e){console.error(" GLB読み込みエラー:",e)})),(new d.B).load("./Model/TitleModel/Title.glb",(function(e){D=e.scene,D.scale.set(.5,.5,.5),D.position.set(2.5,0,4),D.rotation.y=-Math.PI/3,y.add(D),V(D),console.log(" GLBモデル読み込み完了")}),void 0,(function(e){console.error(" GLB読み込みエラー:",e)})),(new d.B).load("./Model/MicModel/mic.glb",(function(e){$=e.scene,$.scale.set(.12,.11,.12),$.position.set(.8,0,2),$.rotation.y=-Math.PI/8,y.add($),V($),console.log(" GLBモデル読み込み完了"),de=$,le.visible=!0,se.innerHTML='\n      <p style="text-align: center; margin: 0px;">\n        Select Music<br>\n        ⇩\n      </p>\n    ',se.style.opacity=0,s.Ay.to(se,{opacity:1,duration:.6})}),void 0,(function(e){console.error(" GLB読み込みエラー:",e)})),(new d.B).load("./Model/TeleScopeModel/Telescope.glb",(function(e){F=e.scene,F.scale.set(.5,.5,.5),F.position.set(-1.5,0,2.4),F.rotation.y=Math.PI,y.add(F),V(F),console.log(" GLBモデル読み込み完了")}),void 0,(function(e){console.error(" GLB読み込みエラー:",e)}));const U=4;let j=0;const N=[],G=[];function V(e){N.push(e),j++,j===U&&function(){G.length=0;for(const e of N){if(!e)continue;const t=(new o.NRn).setFromObject(e);G.push(t)}}()}const J={};window.addEventListener("keydown",(e=>J[e.key]=!0)),window.addEventListener("keyup",(e=>J[e.key]=!1));const Z=new o.Pq0,Y=new o.Pq0,Q=new o.Pq0,X=new o.Pq0,K=new o.Pq0,ee=new o.Pq0(0,-1.6,0),te=new o.Pq0(0,0,5),ne=document.getElementById("hologramBillboard"),oe=new r.on(ne);ne.style.display="block",oe.scale.set(.005,.005,.005),oe.visible=!1,y.add(oe);const ie=document.getElementById("ampMessageBillboard"),ae=new r.on(ie);ie.style.display="block",ae.scale.set(.005,.005,.005),ae.visible=!1,y.add(ae);const re=document.createElement("div");re.id="clickHereContainer";const se=document.createElement("div");se.id="clickHerePrompt",re.appendChild(se);const le=new r.on(re);se.style.display="block",le.scale.set(.01,.01,.01),le.position.set(0,0,0),y.add(le);let de=null;function ce(){de=F,le.visible=!0,se.innerHTML='\n      <p style="text-align: center; margin: 0px;">\n        Click Here<br>\n        ⇩\n      </p>\n    ',se.style.opacity=0,s.Ay.to(se,{opacity:1,duration:.6,onComplete:()=>{Ee=!0}})}const pe=new a.N(h,p.domElement);pe.enableDamping=!0,pe.dampingFactor=.07,pe.enabled=!0,pe.enablePan=!1,pe.enableZoom=!1,pe.target.set(0,1.6,4.9);const ue=h.position.clone(),ye=h.quaternion.clone();let he,me="init",ge=!1;function we(e){const t=document.getElementById("fadeOverlay");t.style.pointerEvents="auto",t.style.opacity="1",setTimeout((()=>e&&e()),1e3)}function fe(e){const t=document.getElementById("fadeOverlay");t.style.opacity="0",setTimeout((()=>{t.style.pointerEvents="none",e&&e()}),1e3)}function Pe(){he&&y.remove(he);const e=new o.Gu$(80,64,64),t=new o.V9B({color:0,side:o.hsX,transparent:!0,opacity:1,depthWrite:!1,depthTest:!0});he=new o.eaF(e,t),he.renderOrder=-1,he.frustumCulled=!1,y.add(he);const n=new o.LoY,i=[],a=[],r=new o.Q1f;for(let e=0;e<1500;e++){const e=49.5,t=2*Math.random()*Math.PI,n=Math.acos(2*Math.random()-1),o=e*Math.sin(n)*Math.cos(t),s=e*Math.sin(n)*Math.sin(t),l=e*Math.cos(n);i.push(o,s,l),r.setHSL(Math.random(),1,.7+.3*Math.random()),a.push(r.r,r.g,r.b)}n.setAttribute("position",new o.qtW(i,3)),n.setAttribute("color",new o.qtW(a,3));const l=new o.BH$({size:.2,vertexColors:!0,transparent:!0,opacity:.8}),d=new o.ONl(n,l);return he.add(d),s.Ay.to(l,{opacity:.3+.5*Math.random(),duration:2+2*Math.random(),yoyo:!0,repeat:-1,ease:"sine.inOut"}),d.name="starSphere",d}Pe();const ve=new o.YJl;ve.position.set(0,0,0),ve.rotation.set(0,0,0),ve.scale.set(1,1,1),ve.renderOrder=399,y.add(ve);const be=[];function xe(e,t,n=null,i=4e3){const a=Math.max(i/1e3,1.5),r=function(e,{canvasSize:t=1024,xStep:n=1,yStep:i=1,threshold:a=128,font:r='bold 48px "Noto Sans JP", Meiryo, sans-serif',scale:s=120}={}){const l=document.createElement("canvas");l.width=l.height=t;const d=l.getContext("2d");d.clearRect(0,0,t,t),d.fillStyle="white",d.font=r,d.textAlign="center",d.textBaseline="middle",d.fillText(e,t/2,t/2);const c=d.getImageData(0,0,t,t).data,p=[];for(let e=0;e<t;e+=i)for(let o=0;o<t;o+=n)c[4*(e*t+o)+3]>a&&p.push({x:o,y:e});let u=0,y=0;p.forEach((({x:e,y:t})=>{u+=e,y+=t}));const h=u/p.length,m=y/p.length;return p.map((({x:e,y:n})=>{const i=(e-h)/t*s,a=(m-n)/t*s,r=1.5*(Math.random()-.5);return new o.Pq0(i,a,r)}))}(e,{canvasSize:1024,xStep:1,yStep:1,scale:120,font:'bold 48px "Noto Sans JP", Meiryo'}),l=new o.Pq0;h.getWorldDirection(l);const d=55+5*Math.random(),c=h.position.clone().add(l.clone().multiplyScalar(d)),p=n||c,u=function(e){const t=new o.Pq0;h.getWorldDirection(t);const n=(new o.Pq0).crossVectors(t,h.up).normalize(),i=[...Array(e.length).keys()].sort(((t,n)=>e[t].x-e[n].x)),a=e[i[0]],r=e[i[i.length-1]];return(new o.Pq0).subVectors(r,a).normalize().dot(n)>=0?n:n.negate()}(r),y=function(e,{sizeRange:t=[.1,.3],colorHueRange:n=[0,1],sortDirection:i=null}={}){const a=e.length,r=[],l=[],d=[],c=new Float32Array(a).fill(0);for(let i=0;i<a;i++){const a=new o.Pq0(7*(Math.random()-.5),7*(Math.random()-.5),7*(Math.random()-.5)),s=e[i].clone().add(a);r.push(...s.toArray());const c=Math.random()*(n[1]-n[0])+n[0],p=(new o.Q1f).setHSL(c,1,.7);l.push(p.r,p.g,p.b);const u=2*Math.random()*(t[1]-t[0])+t[0];d.push(u)}const p=new o.LoY;p.setAttribute("position",new o.qtW(r,3)),p.setAttribute("aColor",new o.qtW(l,3)),p.setAttribute("aSize",new o.qtW(d,1)),p.setAttribute("aOpacity",new o.qtW(c,1));const u=new o.BKk({transparent:!0,blending:o.EZo,depthTest:!1,depthWrite:!1,uniforms:{uTime:{value:0},uOpacity:{value:1}},vertexShader:"\n      attribute float aSize;\n      attribute vec3 aColor;\n      attribute float aOpacity;\n      varying vec3 vColor;\n      varying float vOpacity;\n      uniform float uTime;\n      void main(){\n        vColor = aColor;\n        vOpacity = aOpacity;\n        vec4 mv = modelViewMatrix * vec4(position,1.0);\n        gl_PointSize = aSize * (300.0 / -mv.z) * clamp(uTime, 0.0, 1.0);\n        gl_Position = projectionMatrix * mv;\n      }",fragmentShader:"\n      varying vec3 vColor;\n\n      varying float vOpacity;\n      uniform float uOpacity;\n      void main(){\n        float d = distance(gl_PointCoord, vec2(0.5));\n        if(d > 0.5) discard;\n        float alpha = mix(0.0, 1.0, vOpacity);\n        gl_FragColor = vec4(vColor, alpha * uOpacity);\n      }"}),y=new o.ONl(p,u);y.renderOrder=445;const h=p.getAttribute("position"),m=p.getAttribute("aOpacity"),g=[...Array(a).keys()];return i&&g.sort(((t,n)=>e[t].dot(i)-e[n].dot(i))),g.forEach(((t,n)=>{const i=new o.Pq0(h.getX(t),h.getY(t),h.getZ(t)),a=e[t];s.Ay.to(c,{[t]:1,delay:2e-4*n,duration:.3,ease:"power2.out",onUpdate:()=>{m.array[t]=c[t],m.needsUpdate=!0}}),s.Ay.to(i,{x:a.x,y:a.y,z:a.z,delay:2e-4*n,duration:.5,ease:"power2.out",onUpdate:()=>{h.setXYZ(t,i.x,i.y,i.z),h.needsUpdate=!0}})})),y}(r,{sizeRange:[.1,.25],colorHueRange:[0,1],sortDirection:u});y.position.copy(p),ve.add(y);const m=[...Array(r.length).keys()];m.sort(((e,t)=>r[e].dot(u)-r[t].dot(u)));const g=y.material;return s.Ay.to(g.uniforms.uTime,{value:1,duration:1,ease:"power2.out"}),s.Ay.to(g.uniforms.uOpacity,{value:1,duration:.8,ease:"power2.out",onComplete:()=>{const e=y.geometry.getAttribute("position"),t=y.geometry.getAttribute("aOpacity"),n=t.array,i=[];for(let t=0;t<e.count;t++){const n=(new o.Pq0).fromBufferAttribute(e,t),a=new o.Pq0(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize().multiplyScalar(2+4*Math.random());i.push(n.clone().add(a))}m.forEach(((r,l)=>{const d=i[r];if(!d)return;const c=(new o.Pq0).fromBufferAttribute(e,r);s.Ay.to(c,{x:d.x,y:d.y,z:d.z,delay:a-.8+2e-4*l,duration:1.5,ease:"power2.out",onUpdate:()=>{e.setXYZ(r,c.x,c.y,c.z),e.needsUpdate=!0}}),s.Ay.to(n,{[r]:0,delay:a-.8+2e-4*l,duration:1.5,ease:"power2.out",onUpdate:()=>{t.array[r]=n[r],t.needsUpdate=!0}})}))}}),{text:e,startTime:t,center:p,points:y}}const Me=new o.YJl;y.add(Me);const Ie=[],qe=new o.Tap;["./texture/astro1.png","./texture/astro2.png","./texture/astro3.png","./texture/astro1.png","./texture/astro2.png","./texture/astro3.png","./texture/astro1.png","./texture/astro2.png","./texture/astro3.png"].forEach((e=>{qe.load(e,(e=>Ie.push(e)),void 0,(t=>console.error("Nebula load error",e,t)))}));const Se=new o.tBo;let Ae;window.addEventListener("mousemove",(function(e){Ue.x=e.clientX/window.innerWidth*2-1,Ue.y=-e.clientY/window.innerHeight*2+1}));let Oe=!1,Ee=!1,Ce=!1,ze=!1;function Te(e,t){let n=e;for(;n;){if(n===t)return!0;n=n.parent}return!1}Ae=new class{constructor(e){this.player=new l.ai(e),this.listeners={},this.videoReady=!1,this.songReady=!1,this.song=null,this._holoSliderTimeUpdateRegistered=!1,this.loopOnEnd=!1,this.player.addListener({onAppReady:e=>{console.log("TextAlive App Ready"),this.appReady=!0,this._emit("appready",e);let t=null,n=0;this.player.addListener({onTimeUpdate:e=>{if(!this.player.video)return;this._emit("timeupdate",e);const i=this.player.video.duration||0;if(!ze)return;if(this.loopOnEnd&&be.forEach(((t,o)=>{if(!t.returned&&t.startTime>n&&e>=t.startTime){console.log(`戻す星群 idx=${o} phrase="${t.text}" startTime=${t.startTime}`);const e=this.player.video.findPhrase(t.startTime),n=(e?.endTime||t.startTime+4e3)-t.startTime,i=xe(t.text,t.startTime,t.center,n);be[o]={...t,...i,returned:!0}}})),n=e,"exploringStars"!==me)return;const a=this.player.video.findPhrase(e);a&&a.startTime!==t&&(t=a.startTime,console.log(a.text),function(e,t){console.log(" onNewPhrase:",e.text,"at",t);const n=e.startTime,i=(e.endTime||n+4e3)-n,a=xe(e.text,t,null,i);(function(e,t=500){console.log(" spawnExplosionStars called at",e);const n=[],i=[],a=[],r=[],l=new o.Q1f;for(let s=0;s<t;s++){const t=50,s=new o.Pq0((Math.random()-.5)*t,(Math.random()-.5)*t,(Math.random()-.5)*t),d=(new o.Pq0).copy(e),c=(new o.Pq0).copy(e).add(s);n.push(d.x,d.y,d.z),i.push(c.x,c.y,c.z),l.setHSL(Math.random(),.6,.6+.3*Math.random()),a.push(l.r,l.g,l.b),r.push(1.8+1*Math.random())}const d=new o.LoY;d.setAttribute("position",new o.qtW(n,3)),d.setAttribute("aTarget",new o.qtW(i,3)),d.setAttribute("aColor",new o.qtW(a,3)),d.setAttribute("aSize",new o.qtW(r,1));const c=new o.BKk({transparent:!0,depthTest:!0,depthWrite:!1,blending:o.EZo,vertexColors:!0,uniforms:{uTime:{value:0},uFlicker:{value:0},uOpacity:{value:1}},vertexShader:"\n      attribute vec3 aTarget;\n      attribute vec3 aColor;\n      attribute float aSize;\n      varying vec3 vColor;\n      uniform float uTime;\n      uniform float uFlicker;\n      void main() {\n        vec3 newPos = mix(position, aTarget, uTime);\n        vec4 mvPosition = modelViewMatrix * vec4(newPos, 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n        float flick = 0.3 + 0.1 * sin(uFlicker + aSize * 1.5);\n        float pointSize = aSize * (300.0 / abs(mvPosition.z)) * flick;\n        gl_PointSize = floor(pointSize) + 0.4;\n        vColor = aColor;\n      }\n    ",fragmentShader:"\n      varying vec3 vColor;\n      uniform float uOpacity;\n      void main() {\n        float d = distance(gl_PointCoord, vec2(0.5));\n        float alpha = smoothstep(0.5, 0.4, d) * uOpacity;\n        //if (alpha < 0.01) discard;\n        gl_FragColor = vec4(vColor, alpha);\n      }\n    "}),p=new o.ONl(d,c);p.renderOrder=222,p.frustumCulled=!1,Me.add(p),s.Ay.to(c.uniforms.uTime,{value:1,duration:1,ease:"power2.out"}),s.Ay.to(c.uniforms.uFlicker,{value:2*Math.PI,duration:2,repeat:-1,ease:"linear"})})(a.center),function(e){if(0!==Ie.length)for(let t=0;t<1;t++){const t=Ie[Math.floor(Math.random()*Ie.length)],n=new o.bdM(1,1),i=new o.V9B({map:t,transparent:!0,opacity:0,depthWrite:!1,depthTest:!0,blending:o.EZo,side:o.$EB}),a=new o.eaF(n,i);a.renderOrder=111,a.frustumCulled=!1,a.position.copy(e);const r=35+10*Math.random();a.scale.set(r,r,1),a.userData.lookAtCamera=!0,Me.add(a),s.Ay.to(i,{opacity:.1,duration:1.5,ease:"power2.out"}),s.Ay.to(a.scale,{x:r+8,y:r+8,duration:3,ease:"sine.inOut"})}else console.warn(" nebula textures not yet loaded")}(a.center),a.returned=!1,be.push(a),console.log("   → allLyricData length:",be.length)}(a,e)),i&&e>=i-100&&(console.log("曲終了検出"),"exploringStars"===me&&(we((()=>{!function(){if("exploringStars"!==me)return;me="resettingCamera",ge=!0,pe.enabled=!1,pe.minPolarAngle=Math.PI/4,pe.maxPolarAngle=Math.PI,h.position.copy(ue),h.quaternion.copy(ye);const e=new o.Pq0(0,0,-.01);e.applyQuaternion(h.quaternion).add(h.position),pe.target.copy(e),pe.update(),ge=!1}(),F&&(F.visible=!0),document.getElementById("vignetteOverlay").style.opacity="0",me="viewing",I.visible=!0,S.visible=!0,S.material.opacity=1,O.visible=!0,O.material.opacity=1,L(),k(),pe.enabled=!0,fe(),t=null})),this.loopOnEnd=!0))}})},onVideoReady:async e=>{console.log("Video Ready",e),this.videoReady=!0;const t=this.player.data.song;let n=0;for(;!t?.name&&n++<10;)console.log("曲情報を待機中...",n),await this._sleep(100);t?.name?(this.songReady=!0,this.song=t,console.log("曲名:",t.name)):console.warn("曲情報取得に失敗"),this._emit("videoready",e)},onPlay:()=>this._emit("play"),onPause:()=>{console.log("⏸ onPause");const e=this.player.timer.position,t=this.player.video?.duration||0;if(this.loopOnEnd&&t&&e>=t-200)return console.log(" 終了直後のpause検出 → 再生再開"),be.forEach((e=>e.returned=!1)),void this.restartCurrentSong();this._emit("pause")},onStop:()=>{this._emit("stop")}})}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}_emit(e,t){(this.listeners[e]||[]).forEach((e=>e(t)))}_sleep(e){return new Promise((t=>setTimeout(t,e)))}async loadSong(e){try{console.log("loadSong 開始:",e.url),this.player&&this.player.isPlaying&&this.player.requestStop()}catch(e){console.warn("loadSong: stop失敗（無視）",e.name,e.message)}this.videoReady=!1,this.songReady=!1,this.song=null;try{await this.player.createFromSongUrl(e.url,{video:{beatId:e.beatId,chordId:e.chordId,repetitiveSegmentId:e.repetitiveSegmentId,lyricId:e.lyricId,lyricDiffId:e.lyricDiffId}})}catch(e){throw console.error("createFromSongUrl: エラー",e.name,e.message),e}let t=0;for(;!this.videoReady&&t++<10;)await this._sleep(300);if(!this.videoReady)throw new Error("videoReady タイムアウト");return!0}async safePlay(e=!0){try{if(!this.player.mediaElement)return void console.warn("mediaElement が未定義です");if(console.log("safePlay 実行開始"),this.player.mediaElement.paused)try{this.player.requestPlay()}catch(e){if("AbortError"!==e.name)throw e;console.warn("AbortError: play() が中断されました。pause() が割り込んだ可能性")}if(await this._sleep(200),!this.player.isPlaying&&e){console.warn("再試行: requestPlay");try{this.player.requestPlay()}catch(e){"AbortError"===e.name?console.warn("再試行でも AbortError:",e.message):console.warn("再試行も中断:",e)}}}catch(e){console.error("requestPlay 完全失敗",e)}}async safePause(){try{this.player.requestPause()}catch(e){console.error("requestPause エラー",e)}}async safeStop(){try{this.player.requestStop()}catch(e){console.error("requestStop エラー",e)}}getPlayer(){return this.player}getCurrentSong(){return this.song}get isPlaying(){return this.player.isPlaying}restartCurrentSong(){this.player&&this.player.video&&(this.player.requestMediaSeek(0),setTimeout((()=>{this.safePlay()}),500))}}({app:{token:"F3s1rJugVHrXdNRN"},mediaElement:document.querySelector("#media")}),se.addEventListener("click",(()=>{const e=se.innerHTML;if(e.includes("Click Here")){if(!Ae.player.video||!Ee)return;console.log("望遠鏡クリック"),_e()}else e.includes("Select Music")&&(console.log("マイククリック"),Oe=!0,s.Ay.to(se,{opacity:0,duration:.6,onComplete:()=>{le.visible=!1,Re(),He(),setTimeout((()=>{ce()}),3e3)}}))})),window.addEventListener("mousedown",(e=>{const t=Se.intersectObjects(y.children,!0);if(t.length>0){const e=t[0].object;if(console.log(e),"init"===me&&!Oe&&$&&Te(e,$))console.log("マイククリック"),Oe=!0,s.Ay.to(se,{opacity:0,duration:.6,onComplete:()=>{le.visible=!1,Re(),He(),setTimeout((()=>{ce()}),3e3)}});else if("init"===me&&!Ce&&F&&Te(e,F)){if(!Ae.player.video||!Ee)return;console.log("望遠鏡クリック"),Ce=!0,_e()}else"viewing"!==me&&"init"!==me||!_||!Te(e,_)||ae.visible||(console.log("アンプクリック"),function(){const e=new o.Pq0;_.getWorldPosition(e),e.y+=2,ae.position.copy(e),ae.visible=!0,ae.scale.set(1e-4,1e-4,1e-4);const t=document.getElementById("ampMessageBillboard");t.style.opacity=0,t.innerHTML="viewing"===me?'\n      <div style="text-align: center; line-height: 1.6;">\n        <h2 style="font-size: 22px; color: #aaffff;">遊んでくれてありがとう！</h2>\n        <hr style="border: none; border-top: 1px solid #88ccff; margin: 1em 0;">\n        <p style="font-size: 16px; color: #aaffff;">使用させていただいたイラスト</p>\n        <p style="font-size: 10px; color: #aaffff;">\n          シルエット初音ミク(修正版)-- 栄光の幕切れ様<br>\n          シルエット巡音ルカ(修正版)-- 栄光の幕切れ様<br>\n          鏡音リン&鏡音レン透過シルエット-- Naut_As様\n        </p>\n      </div>\n    ':'\n      <div style="text-align: center; line-height: 1.6;">\n        <h2 style="font-size: 22px; margin-bottom: 10px; color: #aaffff;">\n          曲を選んでみよう\n        </h2>\n        <p style="font-size: 16px; color: #aaffff;">\n          マイクをクリックして曲を選ぼう<br>\n          選び終わったら望遠鏡を覗いてみよう\n        </p>\n        <hr style="border: none; border-top: 1px solid #88ccff; margin: 1em 0;">\n        <p style="font-size: 14px; color: #aaffff;">\n          星空には隠れた〇〇があるかも…？\n        </p>\n      </div>\n    ',s.Ay.to(ae.scale,{x:.005,y:.005,z:.005,duration:.8,ease:"expo.out"}),s.Ay.to(t,{opacity:1,duration:.8,ease:"power2.out"}),s.Ay.to(ae.scale,{x:1e-4,y:1e-4,z:1e-4,delay:5,duration:1.5,ease:"expo.in"}),s.Ay.to(t,{opacity:0,delay:5,duration:1.5,ease:"expo.in",onComplete:()=>{ae.visible=!1}})}())}}));let ke=null,Le=null,Be=null,We=0;function Re(){const e=document.querySelector(".slider-wrapper");function t(e){const t=Math.floor(e/1e3);return`${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`}e.innerHTML="",Ae._holoSliderTimeUpdateRegistered||(Ae._holoSliderTimeUpdateRegistered=!0,Ae.on("timeupdate",(e=>{Le&&Be&&function(e){const n=Ae.player.video;if(!n)return;const o=n.duration,i=e/o*100;Le.value=i,Be.textContent=`${t(e)} / ${t(o)}`}(e)}))),Fe.forEach(((t,n)=>{const o=document.createElement("div");o.className="slide",o.dataset.index=n,o.innerHTML=`\n      <div class="slide-content">\n        <img class="jacket" src="${t.image}" alt="${t.title}" />\n        <div class="song-info">\n          <h3 class="song-title">${t.title}</h3>\n          <p class="song-artist">${t.artist}</p>\n          <img src="./texture/barlines.png" class="barlines" alt="bars" />\n        </div>\n      </div>\n      <div class="player-controls">\n        <button class="play-btn">▶</button>\n        <input type="range" class="seek-bar" min="0" max="100" value="0" />\n        <span class="time-display">00:00 / 00:00</span>\n      </div>\n    `,e.appendChild(o)}));const n=document.getElementById("slidePrev"),o=document.getElementById("slideNext");async function i(i){We=(We+i+Fe.length)%Fe.length;const a=e.querySelector(".slide").offsetWidth;s.Ay.to(e,{x:-a*We,duration:.3,ease:"power2.out"});const r=e.children[We];ke=r.querySelector(".play-btn"),Le=r.querySelector(".seek-bar"),Be=r.querySelector(".time-display"),n.classList.add("disabled"),o.classList.add("disabled"),ke.classList.add("disabled"),ke.textContent="...",Le.classList.add("disabled"),Le.value=0,Be.textContent="読み込み中...",await Ae.loadSong(Fe[We]),n.classList.remove("disabled"),o.classList.remove("disabled"),ke.classList.remove("disabled"),ke.textContent="▶",Le.value=0;const l=Ae.player.video?.duration||0;Be.textContent=`00:00 / ${t(l)}`,ke.onclick=async()=>{Ae.videoReady&&(Ae.isPlaying?(await Ae.safePause(),ke.textContent="▶",Le.classList.add("disabled"),console.log("[play button] Paused.")):(await Ae.safePlay(),ke.textContent="⏸",Le.classList.remove("disabled"),console.log("[play button] Playing.")))},Le.oninput=()=>{const e=Ae.player.video;if(!e)return;const t=Le.value/100*e.duration;console.log(`[seekBar.input] Requesting seek to: ${t.toFixed(0)}ms`),Ae.player.requestMediaSeek(t)}}n.addEventListener("click",(()=>i(-1))),o.addEventListener("click",(()=>i(1))),i(0)}function He(){const e=new o.Pq0;$.getWorldPosition(e),e.y+=2.1,oe.position.copy(e),oe.visible=!0,oe.scale.set(1e-4,1e-4,1e-4);const t=document.getElementById("hologramBillboard");t.style.opacity=0,s.Ay.to(oe.scale,{x:.005,y:.005,z:.005,duration:.8,ease:"expo.out"}),s.Ay.to(t,{opacity:1,duration:.8,ease:"power2.out"})}function _e(){if("init"!==me)return;if(!Ae.songReady)return;Ae.safePause(),s.Ay.to(se,{opacity:0,duration:.6,onComplete:()=>{le.visible=!1}}),me="telescopeZooming";const e=F.position.clone(),t=h.position.clone(),n=new o.ubm;n.position.copy(t),n.lookAt(e.x+1,e.y,e.z);const i=n.quaternion.clone(),a=h.quaternion.clone();s.Ay.to(h.position,{x:e.x,y:e.y+1.2,z:e.z+.6,duration:2,ease:"power2.inOut"}),s.Ay.to({t:0},{t:1,duration:2,ease:"power2.inOut",onUpdate(){let e=this.targets()[0].t;h.quaternion.copy(a).slerp(i,e);const t=new o.Pq0(0,0,-.01).applyQuaternion(h.quaternion).add(h.position);pe.target.copy(t)},onComplete(){const e=new o.Pq0(0,0,-.01);e.applyQuaternion(h.quaternion).add(h.position),pe.target.copy(e),me="fadingOut",we((async()=>{F&&(F.visible=!1),oe.visible=!1,Pe(),pe.enabled=!0,pe.enableZoom=!1,pe.enablePan=!1,pe.enableRotate=!0,pe.minPolarAngle=Math.PI/2,pe.maxPolarAngle=7*Math.PI/8,h.position.set(F.position.x,2,F.position.z),pe.target.set(F.position.x,2,F.position.z-.1),pe.update(),document.getElementById("vignetteOverlay").style.opacity="1",I.visible=!1,L(),k(!0),setTimeout((()=>{s.Ay.to(S.material,{opacity:0,duration:1.2,onComplete:()=>{S.visible=!1}}),s.Ay.to(O.material,{opacity:0,duration:1.2,onComplete:()=>{O.visible=!1}})}),1e4),fe((()=>{me="exploringStars"})),await Ae._sleep(1500),Ae.restartCurrentSong(),ze=!0}))}})}let De=!1,$e=new o.PTz;h.quaternion.clone($e),pe.addEventListener("start",(()=>{De=!0})),pe.addEventListener("change",(()=>{De&&(h.quaternion.equals($e)||(document.body.style.cursor="grabbing"),$e.copy(h.quaternion))})),pe.addEventListener("end",(()=>{De=!1,document.body.style.cursor="grab"})),Ae.on("appready",(()=>{console.log(" アプリ準備完了")})),Ae.on("videoready",(()=>{console.log(" ビデオ準備完了")})),Ae.on("play",(()=>{const e=Ae.getCurrentSong();e&&console.log(`▶ 再生中: ${e.name} by ${e.artist?.name??"不明"}`)})),Ae.on("pause",(()=>{console.warn(" safePause 呼び出し（スタックトレース）"),console.trace(),console.log("pause")})),Ae.on("stop",(()=>{console.log("stop")}));const Fe=[{title:"ストリートライト",artist:"加賀(ネギシャワーP)",url:"https://piapro.jp/t/ULcJ/20250205120202",image:"./texture/cover.png",beatId:4694275,chordId:2830730,repetitiveSegmentId:2946478,lyricId:67810,lyricDiffId:20654},{title:"アリフレーション",artist:"雨良 Amala",url:"https://piapro.jp/t/SuQO/20250127235813",image:"./texture/cover.png",beatId:4694276,chordId:2830731,repetitiveSegmentId:2946479,lyricId:67811,lyricDiffId:20655},{title:"インフォーマルダイブ",artist:"99piano",url:"https://piapro.jp/t/Ppc9/20241224135843",image:"./texture/cover.png",beatId:4694277,chordId:2830732,repetitiveSegmentId:2946480,lyricId:67812,lyricDiffId:20656},{title:"ハロー、フェルミ。",artist:"ど～ぱみん",url:"https://piapro.jp/t/oTaJ/20250204234235",image:"./texture/cover.png",beatId:4694278,chordId:2830733,repetitiveSegmentId:2946481,lyricId:67813,lyricDiffId:20657},{title:"パレードレコード",artist:"きさら",url:"https://piapro.jp/t/GCgy/20250202202635",image:"./texture/cover.png",beatId:4694279,chordId:2830734,repetitiveSegmentId:2946482,lyricId:67814,lyricDiffId:20658},{title:"ロンリーラン",artist:"海風太陽",url:"https://piapro.jp/t/CyPO/20250128183915",image:"./texture/cover.png",beatId:4694280,chordId:2830735,repetitiveSegmentId:2946483,lyricId:67815,lyricDiffId:20659}],Ue=new o.I9Y;!function e(){if(requestAnimationFrame(e),function(){h.getWorldDirection(X),X.y=0,X.normalize(),K.crossVectors(X,h.up).normalize(),Q.set(0,0,0),(J.ArrowUp||J.w)&&Q.add(Z.copy(X).multiplyScalar(.04)),(J.ArrowDown||J.s)&&Q.add(Z.copy(X).multiplyScalar(-.04)),(J.ArrowLeft||J.a)&&Q.add(Z.copy(K).multiplyScalar(-.04)),(J.ArrowRight||J.d)&&Q.add(Z.copy(K).multiplyScalar(.04));const e=Y.copy(h.position).add(Q).add(ee);if(!(e.distanceTo(te)>4)){for(const t of G)if(t.containsPoint(e))return;h.position.add(Q),pe.target.add(Q)}}(),C(),function(){if(!le.visible||!de)return;const e=new o.Pq0;de.getWorldPosition(e),le.position.set(e.x,e.y+1.7,e.z),le.lookAt(h.position)}(),Se.setFromCamera(Ue,h),$&&F&&_){const e=[];$&&!Oe&&e.push($),F&&!Ce&&Oe&&Ee&&e.push(F),_&&!ae.visible&&e.push(_);const t=Se.intersectObjects(e,!0);document.body.style.cursor=t.length>0?"pointer":"grab"}const t=y.getObjectByName("starSphere");t&&(t.rotation.y+=2e-5),oe.visible&&oe.lookAt(h.position),ae.visible&&ae.lookAt(h.position),ve.children.forEach((e=>{e.lookAt(h.position)})),Me.children.forEach((e=>{e.userData.lookAtCamera&&e.lookAt(h.position)})),ge||pe.update(),p.clear(),p.render(y,h),p.clearDepth(),p.render(m,g),u.render(y,h)}(),window.addEventListener("resize",(()=>{h.aspect=window.innerWidth/window.innerHeight,h.updateProjectionMatrix(),u.setSize(window.innerWidth,window.innerHeight),g.left=-window.innerWidth/2,g.right=window.innerWidth/2,g.top=window.innerHeight/2,g.bottom=-window.innerHeight/2,g.updateProjectionMatrix(),p.setSize(window.innerWidth,window.innerHeight),z&&(L(),k("center"===T))})),window.onerror=function(e,t,n,o,i){console.error("グローバルエラーキャッチ:",{message:e,source:t,lineno:n,colno:o,error:i})},window.addEventListener("unhandledrejection",(e=>{e.reason&&"AbortError"===e.reason.name&&e.preventDefault()}))}},e=>{e.O(0,[300],(()=>e(e.s=866))),e.O()}]);